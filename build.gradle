import java.util.regex.Pattern

allprojects {
    apply plugin: 'java'
    sourceCompatibility = 1.10
    targetCompatibility = 1.10
    ext.author = "Sheryv"
    ext.longName = "ShvTools root"
    ext.className = ""
    ext.site = 'https://github.com/Sheryv/ShvTools'
    ext.kotlin_version = '1.2.60'

    task fatJar(type: Jar) {
        afterEvaluate { Project p ->
            manifest {
                attributes 'Implementation-Title': p.longName,
                        'Implementation-Version': p.version,
                        'Implementation-Vendor': p.author + ', ' + p.site,
                        'Main-Class': p.className
            }
            baseName = project.name + '-all'
            from { configurations.compile.collect { it.isDirectory() ? it : zipTree(it) } }
            with jar
        }
    }


    ext.getVersionName = { path='src/main/resources/version.txt' ->
//    def code = project.hasProperty('versionCode') ? versionCode.toInteger() : -1
//    println "VersionCode is set to $code"
//    return code
        def f = new File((String)path);
        if(!f.exists())
            new File((String)path).withWriterAppend { w ->
                w << "0.1.0"
            }
        def vfile = file(path)
        def patternVersionNumber = Pattern.compile("(\\d+)\\.(\\d+)\\.(\\d+)")
        def version = vfile.getText()
        def matcherVersionNumber = patternVersionNumber.matcher(version)
        matcherVersionNumber.find()
        def majorVersion = Integer.parseInt(matcherVersionNumber.group(1))
        def minorVersion = Integer.parseInt(matcherVersionNumber.group(2))
        def pointVersion = Integer.parseInt(matcherVersionNumber.group(3))
        def newVer = majorVersion + "." + minorVersion + "." + (pointVersion + 1)
        vfile.write(newVer)
        return newVer
    }

}

subprojects {
    repositories {
        mavenLocal()
        mavenCentral()
    }

    dependencies {
        //    compile "org.jetbrains.kotlin:kotlin-stdlib-jdk8:$kotlin_version"
        testCompile group: 'junit', name: 'junit', version: '4.12'
        testCompileOnly group: 'org.projectlombok', name: 'lombok', version: '1.18.2'
        compileOnly group: 'org.projectlombok', name: 'lombok', version: '1.18.2'
        compile group: 'com.google.code.findbugs', name: 'jsr305', version: '3.0.2'
    }
}






//compileKotlin {
//    kotlinOptions.jvmTarget = "1.8"
//}
//compileTestKotlin {
//    kotlinOptions.jvmTarget = "1.8"
//}